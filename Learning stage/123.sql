WITH cta AS(SELECT maker, coalesce(PC.price, coalesce(Laptop.price, Printer.price)) price, count(*) pc FROM Product LEFT JOIN PC ON PC.model = Product.model LEFT JOIN Laptop ON Laptop.model = Product.model LEFT JOIN Printer ON Printer.model = Product.model WHERE PC.price IS NOT NULL OR Laptop.ram IS NOT NULL OR Printer.price IS NOT NULL GROUP BY maker, coalesce(PC.price, coalesce(Laptop.price, Printer.price)) HAVING count(*) > 1), ctm AS (SELECT DISTINCT maker FROM Product) SELECT ctm.maker, sum(coalesce(pc, 0)) AS mc, count(price) AS pc FROM ctm LEFT JOIN cta ON cta.maker = ctm.maker GROUP BY ctm.maker