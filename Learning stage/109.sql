WITH tr AS(SELECT pvt.Q_NAME, CASE WHEN coalesce(pvt.R, 0) = 255 AND coalesce(pvt.G, 0) = 255 AND coalesce(pvt.B, 0) = 255 THEN 'W' WHEN coalesce(pvt.R, 0) = 0 AND coalesce(pvt.G, 0) = 0 AND coalesce(pvt.B, 0) = 0 THEN 'B' ELSE 'S' END AS Col FROM (SELECT Q_ID, Q_NAME, B_VOL, V_COLOR FROM utQ LEFT JOIN utB ON utB.B_Q_ID = utQ.Q_ID LEFT JOIN utV ON utV.V_ID = utB.B_V_ID) t1 pivot(sum(B_VOL) FOR V_COLOR in (R, G, B)) pvt) SELECT tr.Q_NAME, sum(CASE WHEN Col = 'W' THEN 1 ELSE 0 END) over() Whites, sum(CASE WHEN Col = 'B' THEN 1 ELSE 0 END) over() Blacks FROM tr WHERE Col = 'W' OR Col = 'B'