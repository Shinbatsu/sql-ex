WITH dsPgs AS(SELECT p.ID_psg, IIF(DATEDIFF(DAY, min(date), '2003-04-01') > 0, '2003-04-01', min(date)) mindate, IIF(DATEDIFF(DAY, max(date), '2003-04-30') > 0, max(date), '2003-04-30') maxdate FROM Pass_in_trip p GROUP BY p.ID_psg) SELECT p.name, IIF(DATEDIFF(DAY, dsPgs.mindate, dsPgs.maxdate) + 1 < 0, 0, DATEDIFF(DAY, dsPgs.mindate, dsPgs.maxdate) + 1) FROM dsPgs, Passenger p WHERE p.ID_psg = dsPgs.ID_psg