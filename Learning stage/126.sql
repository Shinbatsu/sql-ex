WITH _ AS(SELECT ID_psg, count(*) AS ct, max(count(*)) over() AS mct FROM Pass_in_trip GROUP BY ID_psg), ctf AS (SELECT _.*, Passenger.name FROM _ JOIN Passenger ON Passenger. ID_psg = _. ID_psg WHERE ct = mct), ctg AS (SELECT row_number() over( ORDER BY ID_psg) AS rn, count(*) over() AS cr, ID_psg, name FROM Passenger) SELECT ctf.name AS psg, CASE WHEN ctg.R = 1 THEN (SELECT name FROM ctg ga WHERE ga.R = ctg.cr) ELSE (SELECT name FROM ctg ga WHERE ga.R = ctg.R - 1) END AS prev, CASE WHEN ctg.R = ctg.cr THEN (SELECT name FROM ctg ga WHERE ga.R = 1) ELSE (SELECT name FROM ctg ga WHERE ga.R = ctg.R + 1) END AS NEXT FROM ctf JOIN ctg ON ctg. ID_psg = ctf. ID_psg;