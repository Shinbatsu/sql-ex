WITH ctz AS(SELECT DISTINCT B_DATETIME FROM utB), ctn AS (SELECT row_number() over( ORDER BY a. B_DATETIME) rn, a. B_DATETIME a_date, b. B_DATETIME b_date FROM ctz a JOIN ctz b ON datediff(SECOND, a. B_DATETIME, b. B_DATETIME) = 1), cta AS (SELECT *, (SELECT count(*) FROM ctn) cng FROM ctn), ctb AS (SELECT rn crn, cta. a_date, cta. b_date, cng FROM cta WHERE rn = 1 UNION ALL SELECT crn + 1 crn, CASE WHEN (SELECT b. a_date FROM cta b WHERE b.rn = (cb.crn + 1)) = cb.b_date THEN cb. a_date ELSE (SELECT b. a_date FROM cta b WHERE b.rn = (cb.crn + 1)) END a_date, (SELECT b. b_date FROM cta b WHERE b.rn = (cb.crn + 1)) b_date, cng FROM ctb cb WHERE crn < cng) SELECT ctb. a_date date_begin, max(b_date) date_end FROM ctb GROUP BY ctb. a_date;